@page
@model BPCalculator.Pages.BloodPressureModel

@{
    ViewData["Title"] = "BP Category Calculator";
}

<h4>BP Category Calculator</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form method="post" id="form1">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="form-group">
                <label asp-for="BP.Systolic" class="control-label"></label>
                <input asp-for="BP.Systolic" class="form-control" placeholder="Enter Systolic Value" value="@Model.BP?.Systolic" />
                <span asp-validation-for="BP.Systolic" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="BP.Diastolic" class="control-label"></label>
                <input asp-for="BP.Diastolic" class="form-control" placeholder="Enter Diastolic Value" value="@Model.BP?.Diastolic" />
                <span asp-validation-for="BP.Diastolic" class="text-danger"></span>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary">Submit</button>
                <button type="submit" asp-page-handler="Clear" class="btn btn-secondary">Clear</button>
            </div>

            @* Results section, only show when values entered *@
            @if (ViewData.ModelState.IsValid && Model.BP != null && (Model.BP.Systolic != 0 || Model.BP.Diastolic != 0))
            {
                <div class="alert alert-info mt-3">
                    <p><strong>Blood Pressure Category:</strong> @Model.BP.Category</p>
                    <p><strong>Immediate Risk Level:</strong> @Model.BP.HeartRiskLevel</p>
                    <p><strong>Long-term Cardiovascular Risk:</strong> @Model.BP.CardiovascularRisk</p>
                </div>
            }
        </form>
    </div>
</div>
@* Chart only renders if BP values exist *@
@if (Model.BP != null && (Model.BP.Systolic != 0 || Model.BP.Diastolic != 0))
{
<h2>Blood Pressure Chart</h2>
<div style="width: 600px; height: 400px;">
    <canvas id="bpChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const systolic = @Model.BP.Systolic;
        const diastolic = @Model.BP.Diastolic;

        const ctx = document.getElementById('bpChart').getContext('2d');

        const bpChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    { label: 'Low Blood Pressure', data: [{ x: 40, y: 70 }, { x: 59, y: 89 }], backgroundColor: 'rgba(128,0,128,0.3)', pointRadius: 0, showLine: true, fill: true },
                    { label: 'Healthy', data: [{ x: 60, y: 90 }, { x: 80, y: 120 }], backgroundColor: 'rgba(0,128,0,0.3)', pointRadius: 0, showLine: true, fill: true },
                    { label: 'Slightly Raised', data: [{ x: 81, y: 121 }, { x: 84, y: 134 }], backgroundColor: 'rgba(255,255,0,0.4)', pointRadius: 0, showLine: true, fill: true },
                    { label: 'High Blood Pressure', data: [{ x: 85, y: 135 }, { x: 99, y: 169 }], backgroundColor: 'rgba(255,0,0,0.4)', pointRadius: 0, showLine: true, fill: true },
                    { label: 'Your BP Reading', data: [{ x: diastolic, y: systolic }], pointStyle: 'cross', borderColor: 'black', backgroundColor: 'black', pointRadius: 12 }
                ]
            },
            options: {
                scales: {
                    x: { title: { display: true, text: 'Diastolic (mmHg)' }, min: 40, max: 100 },
                    y: { title: { display: true, text: 'Systolic (mmHg)' }, min: 70, max: 170 }
                }
            }
        });
    </script>

    <div class="row">
    <div class="container container-full">
        <div class="fc-6 fc-md-12 flex fa-c bg-white">
            <div class="inner-half left p-tblr fc-12">
                <div class="p-tb-large p-lr h-styled font-large">
                    <h2>Blood Pressure Categories</h2>
                    <p>Use our blood pressure table to see what your reading means.</p>
                    <h4>Stage 1 - Hypertension</h4>
                    <p>Average home readings of &gt;135/85 mmHg or clinic readings of &gt;140/90 mmHg, but less than Stage 2.</p>
                    <p>Typically, medical treatment would be offered in addition to lifestyle advice if the person is less than 80 years old and have any of the following: established damage in the body from hypertension, known to be at increased risk of damage, or if they have kidney disease, diabetes or cardiovascular disease.</p>
                    <p>For those 80y or older, it is important to consider potential frailty and the associated risks of causing more harm by treating (e.g., lowering the blood pressure by so much that they fall and break a hip, or risks from the medication itself).</p>

                    <h4>Stage 2 - Hypertension</h4>
                    <p>Average home readings of &gt;150/95 mmHg or clinic readings of &gt;160/110 mmHg but less than Stage 3. Generally, all ages would be offered treatment in addition to lifestyle advice.</p>
                    <p>Those under 40 years old may be referred for further investigations into a possible underlying cause.</p>

                    <h4>Stage 3 - Hypertension</h4>
                    <p>A clinic reading of 180/120 mmHg (this means <em>either</em> the top reading is above 180 mmHg <em>or</em> the bottom reading is above 120 mmHg – they don’t both need to be above this level).</p>
                    <p>Usually, these patients need to be seen in A&amp;E, especially if there are any other concerning signs or symptoms such as new confusion, chest pain, ankle swelling, shortness of breath, or visual changes.</p>
                    <p>&nbsp;</p>
                </div>
            </div>
        </div>
    </div>
    </div>
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
